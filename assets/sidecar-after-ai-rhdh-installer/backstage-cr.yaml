apiVersion: rhdh.redhat.com/v1alpha3
kind: Backstage
metadata:
  name: ai-rh-developer-hub
  namespace: ai-rhdh
spec:
  application:
    appConfig:
      configMaps:
        - name: developer-hub-base-app-config
        - name: developer-hub-app-config
        - name: argocd-config
      mountPath: /opt/app-root/src
    # this name is dynamically generated by the ai-rhdh-installer and you'll need to change this if you apply all of this
    # file vs. just the extraFiles delta
    dynamicPluginsConfigMapName: backstage-ai-rh-developer-hub-dynamic-plugins-3c140ae5afb4
    extraEnvs:
      secrets:
        - name: ai-rh-developer-hub-env
          # this name is dynamically generated by the ai-rhdh-installer and you'll need to change this if you apply all of this
          # file vs. just the extraFiles delta
        - name: backstage-ai-rh-developer-hub-extra-env-1fdaeeebe65f
        - name: rhdh-argocd-secret
    # start of delta from ai-rhdh-installer for the model-catalog-bridge
    extraFiles:
      mountPath: /opt/app-root/src
      secrets:
        - key: token
          mountPath: /opt/app-root/src
          name: rhdh-rhoai-bridge-token
    # end of delta from ai-rhdh-installer for the model-catalog-bridge
    replicas: 1
    route:
      enabled: true
  database:
    enableLocalDb: true
  deployment:
    patch:
      # start of delta from ai-rhdh-install for the model-catalog-bridge
      spec:
        template:
          spec:
            containers:
              - name: backstage-backend
              - env:
                  - name: NORMALIZER_FORMAT
                    value: JsonArrayFormat
                  - name: POD_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                envFrom:
                  - secretRef:
                      name: rhdh-rhoai-bridge-token
                  - secretRef:
                      name: ai-rh-developer-hub-env
                image: quay.io/redhat-ai-dev/model-catalog-location-service:latest
                imagePullPolicy: Always
                name: location
                ports:
                  - containerPort: 9090
                    name: location
                    protocol: TCP
                volumeMounts:
                  - mountPath: /opt/app-root/src/dynamic-plugins-root
                    name: dynamic-plugins-root
                workingDir: /opt/app-root/src
              - env:
                  - name: NORMALIZER_FORMAT
                    value: JsonArrayFormat
                  - name: STORAGE_TYPE
                    value: ConfigMap
                  - name: BRIDGE_URL
                    value: http://localhost:9090
                  - name: POD_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                envFrom:
                  - secretRef:
                      name: rhdh-rhoai-bridge-token
                  - secretRef:
                      name: ai-rh-developer-hub-env
                image: quay.io/redhat-ai-dev/model-catalog-storage-rest:latest
                imagePullPolicy: Always
                name: storage-rest
                ports:
                  - containerPort: 9090
                    name: location
                    protocol: TCP
                volumeMounts:
                  - mountPath: /opt/app-root/src/dynamic-plugins-root
                    name: dynamic-plugins-root
                workingDir: /opt/app-root/src
              - env:
                  - name: NORMALIZER_FORMAT
                    value: JsonArrayFormat
                  - name: POD_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                envFrom:
                  - secretRef:
                      name: rhdh-rhoai-bridge-token
                  - secretRef:
                      name: ai-rh-developer-hub-env
                image: quay.io/redhat-ai-dev/model-catalog-rhoai-normalizer:latest
                imagePullPolicy: Always
                name: rhoai-normalizer
                ports:
                  - containerPort: 9090
                    name: location
                    protocol: TCP
                volumeMounts:
                  - mountPath: /opt/app-root/src/dynamic-plugins-root
                    name: dynamic-plugins-root
                workingDir: /opt/app-root/src
            # end of delta from ai-rhdh-installer for the model-catalog-bridge
            replicas: 1
